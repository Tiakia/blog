<!DOCTYPE html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.8.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="thinkjs项目结构简析">




  <meta name="keywords" content="thinkjs">










  <link rel="alternate" href="/atom.xml" title="Tiankai's Blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.10.1">



<link rel="canonical" href="http://www.tiankai.party/posts/42422/">



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css">




  <link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css">



<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.10.1">



  
  <script id="baidu_analytics">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?661158ab1e0fccea66251d60f7dae96a";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>





  <script src="//cdn1.lncld.net/static/js/3.1.1/av-min.js"></script>
  <script id="leancloud">
    AV.init({
      appId: "APUSn00FXLoznLkguOHkVcM5-gzGzoHsz",
      appKey: "CgbpSHg5AJ62DOSsKHts1uph"
    });
  </script>





<script>
  window.config = {"leancloud":{"app_id":"APUSn00FXLoznLkguOHkVcM5-gzGzoHsz","app_key":"CgbpSHg5AJ62DOSsKHts1uph"},"toc":true,"fancybox":true,"pjax":true};
</script>

    <title> thinkjs项目结构简析 - Tiankai's Blog </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Tiankai's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            标签
          
        </li>
      </a>
    
      <a href="/categories">
        <li class="mobile-menu-item">
          
          
            分类
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            关于
          
        </li>
      </a>
    
      <a href="/comments">
        <li class="mobile-menu-item">
          
          
            留言板
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Tiankai's Blog</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            
            
              分类
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/comments">
            
            
              留言板
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          thinkjs项目结构简析
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-06-11
        </span>
        
          <span class="post-category">
            
              <a href="/categories/nodejs/">nodejs</a>
            
          </span>
        
        <span class="post-visits">
          8.3k 字
        </span>
        <span class="post-visits">
          36 分钟
        </span>
        
        <span class="post-visits" data-url="/posts/42422/" data-title="thinkjs项目结构简析">
          阅读次数 0
        </span>
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#config-js"><span class="toc-text">config.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Adapter"><span class="toc-text">Adapter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#extend"><span class="toc-text">extend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Middleware"><span class="toc-text">Middleware</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Logic"><span class="toc-text">Logic</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义的校验规则"><span class="toc-text">自定义的校验规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Controller"><span class="toc-text">Controller</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Action-的执行"><span class="toc-text">Action 的执行</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#View"><span class="toc-text">View</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#使用"><span class="toc-text">使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#其他方法"><span class="toc-text">其他方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#默认注入的参数"><span class="toc-text">默认注入的参数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Route"><span class="toc-text">Route</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#think-router-配置"><span class="toc-text">think-router 配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#路由对路径的处理"><span class="toc-text">路由对路径的处理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service"><span class="toc-text">Service</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#无参数类的实例化"><span class="toc-text">无参数类的实例化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#有参数类的实例化"><span class="toc-text">有参数类的实例化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#扩展-Services-类"><span class="toc-text">扩展 Services 类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Model"><span class="toc-text">Model</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#实例化模型"><span class="toc-text">实例化模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ctx-model"><span class="toc-text">ctx.model</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#controller-model"><span class="toc-text">controller.model</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Service-model"><span class="toc-text">Service.model</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cookie-amp-amp-Session"><span class="toc-text">Cookie &amp;&amp; Session</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Cookie"><span class="toc-text">Cookie</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Session"><span class="toc-text">Session</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#session-操作"><span class="toc-text">session 操作</span></a></li></ol></li></ol>
    </div>
  </div>



    <div class="post-content">
      
        <p>thinkjs 项目整合了 koa2.x,兼容了 koa 的所有功能, 同时封装了一些功能,MVC 的架构让开发变的更简单,条理</p>
<a id="more"></a>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">├── development.js                        <span class="comment"># 开发环境启动配置文件</span></span><br><span class="line">├── nginx.conf                            <span class="comment"># NGINX 配置文件</span></span><br><span class="line">├── package.json</span><br><span class="line">├── pm2.json                              <span class="comment"># pm2 配置文件</span></span><br><span class="line">├── production.js                         <span class="comment"># 生产环境启动文件</span></span><br><span class="line">├── README.md</span><br><span class="line">├── releasenotes.txt</span><br><span class="line">├── runtime</span><br><span class="line">│   └── config</span><br><span class="line">│       └── development.json</span><br><span class="line">├── src</span><br><span class="line">│   ├── apidoc.json</span><br><span class="line">│   ├── bootstrap</span><br><span class="line">│   │   ├── master.js                     <span class="comment"># master 进程</span></span><br><span class="line">│   │   └── worker.js                     <span class="comment"># worker 进程</span></span><br><span class="line">│   ├── config                            <span class="comment"># 所有的配置文件</span></span><br><span class="line">│   │   ├── adapter.js                    <span class="comment"># 引入的外部适配器 解决一种功能的多种实现</span></span><br><span class="line">│   │   ├── config.js                     <span class="comment"># 公共配置</span></span><br><span class="line">│   │   ├── config.production.js          <span class="comment"># 生产环境配置</span></span><br><span class="line">│   │   ├── crontab.js                    <span class="comment"># 定时执行的任务</span></span><br><span class="line">│   │   ├── extend.js                     <span class="comment"># 引入的外部扩展配置</span></span><br><span class="line">│   │   ├── middleware.js                 <span class="comment"># 引入的外部中间件</span></span><br><span class="line">│   │   ├── router.js                     <span class="comment"># 自定义路由配置</span></span><br><span class="line">│   │   └── validator.js                  <span class="comment"># 数据校验配置</span></span><br><span class="line">│   ├── controller                        <span class="comment"># 一个页面一个控制器</span></span><br><span class="line">│   │   ├── common</span><br><span class="line">│   │   │   ├── iotSms.js</span><br><span class="line">│   │   │   └── service.js</span><br><span class="line">│   │   ├── rest.js</span><br><span class="line">│   │   ├── sms_record.js</span><br><span class="line">│   │   ├── sys_area.js</span><br><span class="line">│   │   ├── sys_dict.js</span><br><span class="line">│   │   ├── sys_log.js</span><br><span class="line">│   │   ├── sys_menu.js</span><br><span class="line">│   │   ├── sys_office.js</span><br><span class="line">│   │   ├── sys_role.js</span><br><span class="line">│   │   ├── sys_system.js</span><br><span class="line">│   │   ├── sys_user.js</span><br><span class="line">│   ├── extend                            <span class="comment"># 项目里（自定义）的扩展配置</span></span><br><span class="line">│   │   ├── controller.js                 <span class="comment"># 针对 controller 的扩展</span></span><br><span class="line">│   │   ├── service.js                    <span class="comment"># 扩展 service 类</span></span><br><span class="line">│   │   └── think.js                      <span class="comment"># 扩展 think 类</span></span><br><span class="line">│   ├── logic                             <span class="comment"># 控制器之前的数据校验</span></span><br><span class="line">│   │   ├── common                        <span class="comment"># 系统在调用 controller 之前 会先调用</span></span><br><span class="line">│   │   │   └── service.js                <span class="comment"># 同名的 logic 进行数据校验</span></span><br><span class="line">│   │   ├── index.js</span><br><span class="line">│   │   ├── sys_area.js                   <span class="comment"># 和控制器的名字一样</span></span><br><span class="line">│   │   ├── sys_dict.js</span><br><span class="line">│   │   ├── sys_log.js</span><br><span class="line">│   │   ├── sys_menu.js</span><br><span class="line">│   │   ├── sys_office.js</span><br><span class="line">│   │   ├── sys_role.js</span><br><span class="line">│   │   ├── sys_system.js</span><br><span class="line">│   │   └── sys_user.js</span><br><span class="line">│   ├── middleware                        <span class="comment"># 项目中自定义的中间件</span></span><br><span class="line">│   │   ├── eliPagination.js</span><br><span class="line">│   │   └── jwtAuthentication.js</span><br><span class="line">│   ├── model                             <span class="comment"># 数据库操作</span></span><br><span class="line">│   │   ├── base.js</span><br><span class="line">│   │   ├── index.js</span><br><span class="line">│   │   ├── sms_record.js</span><br><span class="line">│   │   ├── sys_application.js</span><br><span class="line">│   │   ├── sys_area.js</span><br><span class="line">│   │   ├── sys_dict.js</span><br><span class="line">│   │   ├── sys_log.js</span><br><span class="line">│   │   ├── sys_menu.js</span><br><span class="line">│   │   ├── sys_office.js</span><br><span class="line">│   │   ├── sys_role.js</span><br><span class="line">│   │   ├── sys_role_menu.js</span><br><span class="line">│   │   ├── sys_role_office.js</span><br><span class="line">│   │   ├── sys_system.js</span><br><span class="line">│   │   ├── sys_user.js</span><br><span class="line">│   │   └── sys_user_role.js</span><br><span class="line">│   ├── proto</span><br><span class="line">│   │   ├── common.js</span><br><span class="line">│   │   ├── common.proto</span><br><span class="line">│   │   ├── helloworld.js</span><br><span class="line">│   │   ├── helloworld.proto</span><br><span class="line">│   │   ├── jwtAuthorizing.js</span><br><span class="line">│   │   ├── jwtAuthorizing.proto</span><br><span class="line">│   │   ├── sms.js</span><br><span class="line">│   │   ├── sms.proto</span><br><span class="line">│   │   ├── sys_log.js</span><br><span class="line">│   │   ├── sys_log.proto</span><br><span class="line">│   │   ├── sys_system.js</span><br><span class="line">│   │   ├── sys_system.proto</span><br><span class="line">│   │   ├── sys_user.js</span><br><span class="line">│   │   └── sys_user.proto</span><br><span class="line">│   └── service                           <span class="comment"># 逻辑操作</span></span><br><span class="line">│       ├── base.js                       <span class="comment"># 调用 model 结果</span></span><br><span class="line">│       ├── common                        <span class="comment"># 返回给 controller</span></span><br><span class="line">│       │   ├── dataAuth.js</span><br><span class="line">│       │   ├── iotChinaMobileService.js</span><br><span class="line">│       │   ├── iotSmsService.js</span><br><span class="line">│       │   ├── jwtAuthorizingService.js</span><br><span class="line">│       │   ├── jwtService.js</span><br><span class="line">│       │   └── smsService.js</span><br><span class="line">│       ├── rpc_service</span><br><span class="line">│       │   ├── rpcclient.js</span><br><span class="line">│       │   └── rpcserver.js</span><br><span class="line">│       ├── sms_record.js</span><br><span class="line">│       ├── sys_application.js</span><br><span class="line">│       ├── sys_area.js</span><br><span class="line">│       ├── sys_dict.js</span><br><span class="line">│       ├── sys_log.js</span><br><span class="line">│       ├── sys_menu.js</span><br><span class="line">│       ├── sys_office.js</span><br><span class="line">│       ├── sys_role.js</span><br><span class="line">│       ├── sys_system.js</span><br><span class="line">│       ├── sys_user.js</span><br><span class="line">│       └── sys_user_role.js</span><br><span class="line">├── view</span><br><span class="line">│   └── index_index.html</span><br><span class="line">└── www</span><br><span class="line">    └── static</span><br><span class="line">        ├── css</span><br><span class="line">        ├── img</span><br><span class="line">        └── js</span><br></pre></td></tr></table></figure>
<p><strong>thinkjs 将框架需要的配置和项目自定义的配置统一管理放在了 <code>src/config</code> 目录下</strong></p>
<ul>
<li><p><code>config.js</code> 通用的一些配置</p>
</li>
<li><p><code>adapter.js</code> 适配器的配置</p>
</li>
<li><p><code>router.js</code> 自定义路由配置</p>
</li>
<li><p><code>middleware.js</code> 中间件配置</p>
</li>
<li><p><code>validator.js</code> 数据校验配置,配合 logic</p>
</li>
<li><p><code>extend.js</code> extends 配置</p>
</li>
</ul>
<p><strong>系统启动时会合并 config.js 和 adapter.js</strong></p>
<h3 id="config-js"><a href="#config-js" class="headerlink" title="config.js"></a>config.js</h3><p>通用的配置文件,也可以根据运行环境创建对应的配置文件 <code>config.development.js</code><br>系统默认配置:</p>
<figure class="highlight javascript"><figcaption><span>src/config.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  port: <span class="number">8360</span>, <span class="comment">// server port</span></span><br><span class="line">  <span class="comment">// host: '127.0.0.1', // server host, removed from 3.1.0</span></span><br><span class="line">  workers: <span class="number">0</span>, <span class="comment">// server workers num, if value is 0 then get cpus num</span></span><br><span class="line">  createServer: <span class="literal">undefined</span>, <span class="comment">// create server function</span></span><br><span class="line">  startServerTimeout: <span class="number">3000</span>, <span class="comment">// before start server time</span></span><br><span class="line">  reloadSignal: <span class="string">"SIGUSR2"</span>, <span class="comment">// reload process signal</span></span><br><span class="line">  stickyCluster: <span class="literal">false</span>, <span class="comment">// sticky cluster, add from 3.1.0</span></span><br><span class="line">  onUnhandledRejection: <span class="function"><span class="params">err</span> =&gt;</span> think.logger.error(err), <span class="comment">// unhandledRejection handle</span></span><br><span class="line">  onUncaughtException: <span class="function"><span class="params">err</span> =&gt;</span> think.logger.error(err), <span class="comment">// uncaughtException handle</span></span><br><span class="line">  processKillTimeout: <span class="number">10</span> * <span class="number">1000</span>, <span class="comment">// process kill timeout, default is 10s</span></span><br><span class="line">  jsonpCallbackField: <span class="string">"callback"</span>, <span class="comment">// jsonp callback field</span></span><br><span class="line">  jsonContentType: <span class="string">"application/json"</span>, <span class="comment">// json content type</span></span><br><span class="line">  errnoField: <span class="string">"errno"</span>, <span class="comment">// errno field</span></span><br><span class="line">  errmsgField: <span class="string">"errmsg"</span>, <span class="comment">// errmsg field</span></span><br><span class="line">  defaultErrno: <span class="number">1000</span>, <span class="comment">// default errno</span></span><br><span class="line">  validateDefaultErrno: <span class="number">1001</span> <span class="comment">// validate default errno</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="Adapter"><a href="#Adapter" class="headerlink" title="Adapter"></a>Adapter</h3><p><code>Adapter</code> 是用来解决一类功能的多种实现，这些实现提供一套相同的接口，类似设计模式里的工厂模式。如：支持多种数据库，支持多种模版引擎等。通过这种方式，可以很方便的在不同的类型中进行切换。<code>Adapter</code> 一般配合 <code>Extend</code> 一起使用。<br><code>Adapter</code> 都是一类功能的不同实现，一般是不能独立使用的，而是配合对应的扩展(extend)一起使用。如：view Adapter（<code>think-view-nunjucks</code>、<code>think-view-ejs</code>）配合 <code>think-view</code>扩展进行使用。<code>Adapter</code> 也支持不同环境的配置文件 <code>Adapter.development.js</code></p>
<p>配置格式:</p>
<figure class="highlight javascript"><figcaption><span>src/config/adapter.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> nunjucks = <span class="built_in">require</span>(<span class="string">'think-view-nunjucks'</span>);</span><br><span class="line"><span class="keyword">const</span> ejs = <span class="built_in">require</span>(<span class="string">'think-view-ejs'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line">exports.view = &#123;</span><br><span class="line">  type: <span class="string">'nunjucks'</span>, <span class="comment">// 默认的模板引擎为 nunjucks</span></span><br><span class="line">  common: &#123; <span class="comment">//通用配置</span></span><br><span class="line">    viewPath: path.join(think.ROOT_PATH, <span class="string">'view'</span>),</span><br><span class="line">    sep: <span class="string">'_'</span>,</span><br><span class="line">    extname: <span class="string">'.html'</span></span><br><span class="line">  nunjucks: &#123; <span class="comment">// nunjucks 的具体配置</span></span><br><span class="line">    handle: nunjucks</span><br><span class="line">  &#125;,</span><br><span class="line">  ejs: &#123; <span class="comment">// ejs 的具体配置</span></span><br><span class="line">    handle: ejs,</span><br><span class="line">    viewPath: path.join(think.ROOT_PATH, <span class="string">'view/ejs/'</span>),</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>type</code> 默认使用的类型,具体调用时可以传递参数改写<code>display/render方法都可以</code></li>
<li><code>common</code> 配置通用的一些参数，项目启动时会跟具体的 adapter 参数作合并</li>
<li><code>nunjucks ejs</code> 配置特定类型的 Adapter 参数最终获取到的参数是 common 参数与该参数进行合并</li>
<li><code>handle</code> 对应类型的处理函数，一般为一个类</li>
</ul>
<p><strong>因为最后 <code>conifg.js</code>会和 <code>adapter.js</code>合并,所以俩个文件的<code>key</code>不能重复</strong></p>
<h3 id="extend"><a href="#extend" class="headerlink" title="extend"></a>extend</h3><p>项目扩展配置,配置文件放在 <code>src/config/extend.js</code></p>
<p>配置格式:</p>
<figure class="highlight javascript"><figcaption><span>src/config/extends.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> view = <span class="built_in">require</span>(<span class="string">"think-view"</span>);</span><br><span class="line"><span class="keyword">const</span> model = <span class="built_in">require</span>(<span class="string">"think-model"</span>);</span><br><span class="line"><span class="keyword">const</span> cache = <span class="built_in">require</span>(<span class="string">"think-cache"</span>);</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">"think-session"</span>);</span><br><span class="line"><span class="keyword">const</span> email = <span class="built_in">require</span>(<span class="string">"think-email"</span>);</span><br><span class="line"><span class="keyword">const</span> fetch = <span class="built_in">require</span>(<span class="string">"think-fetch"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">  view, <span class="comment">// make application support view</span></span><br><span class="line">  model(think.app),</span><br><span class="line">  cache,</span><br><span class="line">  session,</span><br><span class="line">  email,</span><br><span class="line">  fetch <span class="comment">// HTTP request client.</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>如果在项目中需要对<code>think</code>等对象进行扩展可以放在<code>src/extend/</code>目录下</p>
<ul>
<li><code>src/extend/think.js</code>扩展 think 对象 <code>think.xxx</code></li>
<li><code>src/extend/application.js</code>扩展 Koa 里的 app 对象( <code>think.app</code>)</li>
<li><code>src/extend/controller.js</code>扩展 controller 类 ( <code>think.Controller</code>)</li>
<li><code>src/extend/request.js</code>扩展 koa 里的 request 对象 ( <code>think.app.request</code>)</li>
<li><code>src/extend/response.js</code>扩展 koa 里的 response 对象 ( <code>think.app.response</code>)</li>
<li><code>src/extend/context.js</code>扩展 ctx 对象 ( <code>think.app.context</code>)</li>
<li><code>src/extend/logic.js</code>扩展 logic 类 ( <code>think.Logic</code>) logic 继承 controller 类,所以 logic 包含 controller 类所有方法</li>
<li><code>src/extend/services.js</code>扩展 servic 类 ( <code>think.Services</code>)</li>
</ul>
<h3 id="Middleware"><a href="#Middleware" class="headerlink" title="Middleware"></a>Middleware</h3><ul>
<li>中间件的执行顺序是按照 <code>src/config/middleware.js</code> 里配置的顺序来执行的</li>
</ul>
<figure class="highlight javascript"><figcaption><span>middleware.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isDev = (think.env = <span class="string">"develpoment"</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">  &#123;</span><br><span class="line">    handle: <span class="string">"meta"</span>, <span class="comment">//中间件的处理函数</span></span><br><span class="line">    options: &#123;</span><br><span class="line">      <span class="comment">// 当前中间件需要的配置</span></span><br><span class="line">      logRequest: isDev</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    handle: <span class="string">"resource"</span>,</span><br><span class="line">    enable: isDev, <span class="comment">//是否开启当前中间件</span></span><br><span class="line">    options: &#123;</span><br><span class="line">      root: path.join(think.ROOT_PATH, <span class="string">"www"</span>),</span><br><span class="line">      publicPath: <span class="regexp">/^\/(static|favicon)\.ico/</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<ul>
<li>也可以自定义中间件,放在<code>src/middleware/</code>文件下</li>
</ul>
<figure class="highlight javascript"><figcaption><span>jwt.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">options, app</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//这里的 app 为 think.app 对象</span></span><br><span class="line">    reutrn (ctx,next) =&gt; &#123;</span><br><span class="line">    <span class="comment">//do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>然后将自定义的中间件引入<code>src/config/middleware.js</code>中,注意放置顺序</li>
</ul>
<figure class="highlight javascript"><figcaption><span>middleware.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">"../middleware/jwt.js"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">  &#123;</span><br><span class="line">    handle: <span class="string">"meta"</span>, <span class="comment">//中间件的处理函数</span></span><br><span class="line">    options: &#123;</span><br><span class="line">      <span class="comment">// 当前中间件需要的配置</span></span><br><span class="line">      logRequest: isDev</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    handle: <span class="string">"resource"</span>,</span><br><span class="line">    enable: isDev, <span class="comment">//是否开启当前中间件</span></span><br><span class="line">    options: &#123;</span><br><span class="line">      root: path.join(think.ROOT_PATH, <span class="string">"www"</span>),</span><br><span class="line">      publicPath: <span class="regexp">/^\/(static|favicon)\.ico/</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    handle: <span class="string">"jwt"</span>,</span><br><span class="line">    options: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<ul>
<li>一个示例的 middleware.js</li>
</ul>
<figure class="highlight javascript"><figcaption><span>middleware.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="keyword">const</span> isDev = think.env === <span class="string">"development"</span>;</span><br><span class="line"><span class="keyword">const</span> jwtAuthentication = <span class="built_in">require</span>(<span class="string">"../middleware/jwtAuthentication.js"</span>);</span><br><span class="line"><span class="keyword">const</span> koa_cors = <span class="built_in">require</span>(<span class="string">"koa2-cors"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">  &#123;</span><br><span class="line">    handle: <span class="string">"meta"</span>,</span><br><span class="line">    options: &#123;</span><br><span class="line">      logRequest: isDev,</span><br><span class="line">      sendResponseTime: isDev</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    handle: koa_cors,</span><br><span class="line">    options: &#123;</span><br><span class="line">      origin: <span class="string">"*"</span>,</span><br><span class="line">      exposeHeaders: [<span class="string">"Content-Disposition"</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    handle: <span class="string">"resource"</span>,</span><br><span class="line">    enable: isDev,</span><br><span class="line">    options: &#123;</span><br><span class="line">      root: path.join(think.ROOT_PATH, <span class="string">"www"</span>),</span><br><span class="line">      publicPath: <span class="regexp">/^\/(static|favicon\.ico)/</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    handle: <span class="string">"trace"</span>,</span><br><span class="line">    enable: !think.isCli,</span><br><span class="line">    options: &#123;</span><br><span class="line">      debug: isDev,</span><br><span class="line">      error: <span class="function">(<span class="params">err, ctx</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//错误处理</span></span><br><span class="line">        <span class="keyword">return</span> think.logger.error(err);</span><br><span class="line">      &#125;,</span><br><span class="line">      debug: isDev,</span><br><span class="line">      contentType(ctx) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"json"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    handle: <span class="string">"payload"</span>,</span><br><span class="line">    options: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    handle: <span class="string">"router"</span>,</span><br><span class="line">    options: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    handle: <span class="string">"jwtAuthentication"</span>,</span><br><span class="line">    options: think.config(<span class="string">"authOption"</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"logic"</span>,</span><br><span class="line">  <span class="string">"controller"</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>总结:</p>
<ul>
<li>middleware.js 中间件按照从上到下的顺序执行的</li>
<li>一些 think 框架内置的中间就可以直接使用不需要引入,例如:<ul>
<li><code>meta:</code> 显示一些信息,如:发送 ThinkJs 版本号,接口的处理时间</li>
<li><code>resource:</code> 处理静态资源,生产环境建议关闭</li>
<li><code>payload:</code> 处理表单提交的数据</li>
<li><code>router:</code> 路由解析</li>
<li><code>logic:</code> logic 调用,数据校验</li>
<li><code>controller:</code> controller 和 action 调用</li>
</ul>
</li>
</ul>
<h3 id="Logic"><a href="#Logic" class="headerlink" title="Logic"></a>Logic</h3><p>当在 <code>Action</code> 里处理用户的请求时，经常要先获取用户提交过来的数据，然后对其校验，如果校验没问题后才能进行后续的操作；当参数校验完成后，有时候还要进行权限判断等，这些都判断无误后才能进行真正的逻辑处理。如果将这些代码都放在一个 <code>Action</code> 里，势必让 Action 的代码非常复杂且冗长。<br>为了解决这个问题， ThinkJS 在控制器前面增加了一层 <code>Logic</code>，Logic 文件名和 Controller 文件名要相同,Logic 里的 Action 和控制器里的 Action 一一对应，系统在调用控制器里的 Action 之前会自动调用 Logic 里的 Action。</p>
<p>Logic 对应的配置文件是 <code>src/config/validator.js</code>文件</p>
<p>一个完整的 logic 校验格式文件:</p>
<figure class="highlight javascript"><figcaption><span>src/logic/sys_test.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * sys_test logic</span></span><br><span class="line"><span class="comment"> * create by tiankai[lenovo]  2018-06-05 15:07</span></span><br><span class="line"><span class="comment"> * @type &#123;module.exports&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">think</span>.<span class="title">Logic</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 新增验证</span></span><br><span class="line"><span class="comment">   * create by tiankai[lenovo]  2018-06-05 15:07</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  insertAction() &#123;</span><br><span class="line">    <span class="keyword">this</span>.allowMethods = <span class="string">"POST"</span>; <span class="comment">//  只允许 POST 请求类型</span></span><br><span class="line">    <span class="keyword">this</span>.rules = &#123;</span><br><span class="line">      <span class="comment">// aliasName 起别名,显示 用户名不能为空</span></span><br><span class="line">      uname: &#123; <span class="attr">string</span>: <span class="literal">true</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">trim</span>: <span class="literal">true</span>, <span class="attr">aliasName</span>: <span class="string">"用户名"</span> &#125;,</span><br><span class="line">      password: &#123; <span class="attr">string</span>: <span class="literal">true</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">trim</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      type: &#123; <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">in</span>: [<span class="string">"1"</span>, <span class="string">"2"</span>], <span class="attr">trim</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      mobile: &#123; <span class="attr">mobile</span>: <span class="string">"zh-CN"</span>, <span class="attr">trim</span>: <span class="literal">true</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 编辑验证</span></span><br><span class="line"><span class="comment">   * create by tiankai[lenovo]  2018-06-05 15:07</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  editAction() &#123;</span><br><span class="line">    <span class="keyword">this</span>.allowMethods = <span class="string">"put"</span>;</span><br><span class="line">    <span class="keyword">this</span>.rules = &#123;</span><br><span class="line">      id: &#123; <span class="attr">uuid</span>: <span class="literal">true</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">trim</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      uname: &#123; <span class="attr">string</span>: <span class="literal">true</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">trim</span>: <span class="literal">true</span>, <span class="attr">aliasName</span>: <span class="string">"用户名"</span> &#125;,</span><br><span class="line">      password: &#123; <span class="attr">string</span>: <span class="literal">true</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">trim</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      mobile: &#123; <span class="attr">mobile</span>: <span class="string">"zh-CN"</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">trim</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      type: &#123; <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">in</span>: [<span class="string">"1"</span>, <span class="string">"2"</span>], <span class="attr">trim</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 删除验证</span></span><br><span class="line"><span class="comment">   * create by tiankai[lenovo]  2018-06-05 15:07</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  removeAction() &#123;</span><br><span class="line">    <span class="keyword">this</span>.allowMethods = <span class="string">"delete"</span>;</span><br><span class="line">    <span class="keyword">this</span>.rules = &#123;</span><br><span class="line">      id: &#123; <span class="attr">uuid</span>: <span class="literal">true</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">trim</span>: <span class="literal">true</span>, <span class="attr">method</span>: <span class="string">"GET"</span> &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取单条验证</span></span><br><span class="line"><span class="comment">   * create by tiankai[lenovo]  2018-06-05 15:07</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  getAction() &#123;</span><br><span class="line">    <span class="keyword">this</span>.allowMethods = <span class="string">"GET"</span>;</span><br><span class="line">    <span class="keyword">this</span>.rules = &#123;</span><br><span class="line">      id: &#123; <span class="attr">uuid</span>: <span class="literal">true</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">trim</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取多条验证</span></span><br><span class="line"><span class="comment">   * create by tiankai[lenovo]  2018-06-05 15:07</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  getsAction() &#123;</span><br><span class="line">    <span class="keyword">this</span>.allowMethods = <span class="string">"GET"</span>;</span><br><span class="line">    <span class="keyword">this</span>.rules = &#123;</span><br><span class="line">      <span class="comment">//parent_id: &#123;trim: true, uuid: true,&#125;,</span></span><br><span class="line">      <span class="comment">//name: &#123;string: true, required: true, trim: true&#125;,</span></span><br><span class="line">      <span class="comment">//type: &#123;int: &#123;min: 0, max: 1&#125;, trim: true, required: true,&#125;,</span></span><br><span class="line">      remarks: &#123; <span class="attr">string</span>: <span class="literal">true</span>, <span class="attr">trim</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>如代码所示,<code>logic</code>应该和 <code>controller</code>相对应,不仅文件名对应,相对应的 Action 也该对应</p>
<h3 id="自定义的校验规则"><a href="#自定义的校验规则" class="headerlink" title="自定义的校验规则"></a>自定义的校验规则</h3><p>代码中有框架默认的校验规则,也有自己定义的校验规则<br>自己定义的校验规则放到<code>src/config/validator.js</code>文件中</p>
<figure class="highlight javascript"><figcaption><span>src/config/validator.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  messages: &#123;</span><br><span class="line">    ACTION_NON_EXIST: [<span class="number">404</span>, <span class="string">"action 函数不存在."</span>],</span><br><span class="line">    PARENT_DATA_NOT_EXIST: [<span class="number">10001</span>, <span class="string">"父级数据不存在."</span>],</span><br><span class="line">    OPTIONS_REQUEST: [<span class="number">9999</span>, <span class="string">"option 请求。"</span>],</span><br><span class="line">    SUCCESS: [<span class="number">10000</span>, <span class="string">"操作成功。"</span>],</span><br><span class="line">    SERVER_INVALID: [<span class="number">10100</span>, <span class="string">"服务器错误，请重新尝试。"</span>],</span><br><span class="line">    TOKEN_INVALID: [<span class="number">10200</span>, <span class="string">"请核对您的登录信息后重新登录。"</span>],</span><br><span class="line">    NEED_LOGIN: [<span class="number">10201</span>, <span class="string">"您没有权限，请重新登录"</span>],</span><br><span class="line">    TOKEN_EXPIRED: [<span class="number">10202</span>, <span class="string">"TOKEN 过期，请重新登录"</span>],</span><br><span class="line">    NEED_AUTHOR: [<span class="number">10203</span>, <span class="string">"访问资源未授权"</span>],</span><br><span class="line">    DATA_NULL: [<span class="number">10004</span>, <span class="string">"查询不到相关数据"</span>],</span><br><span class="line">    DATA_REPEAT: [<span class="number">10006</span>, <span class="string">"数据重复，请核对数据。"</span>],</span><br><span class="line">    USER_NULL: [<span class="number">10300</span>, <span class="string">"用户不存在"</span>],</span><br><span class="line">    LOGIN_NAME_EXIST: [<span class="number">10301</span>, <span class="string">"登录名已存在."</span>],</span><br><span class="line">    PASSWORD_REPEAT: [<span class="number">10302</span>, <span class="string">"密码与原始密码相同"</span>],</span><br><span class="line">    PASSWORD_ERROR: [<span class="number">10303</span>, <span class="string">"密码错误，请重新登录。"</span>],</span><br><span class="line">    ROLE_NAME_REPEAT: [<span class="number">10330</span>, <span class="string">"角色名称已存在"</span>],</span><br><span class="line">    CAN_NOT_DEL_SELF_ROLE: [<span class="number">10331</span>, <span class="string">"不能删除自己所拥有的角色"</span>],</span><br><span class="line">    CAN_NOT_DEL_ONLY_ROLE: [<span class="number">10332</span>, <span class="string">"该用户的唯一角色，不能移除"</span>],</span><br><span class="line">    NOT_FOUND_ROLE: [<span class="number">10333</span>, <span class="string">"当前用户无角色"</span>],</span><br><span class="line">    NOT_FOUND_PARENT_MENU: [<span class="number">10320</span>, <span class="string">"父菜单不存在"</span>],</span><br><span class="line">    NOT_FOUND_PARENT_OFFICE: [<span class="number">10340</span>, <span class="string">"父机构不存在"</span>],</span><br><span class="line">    LABEL_NAMES_EXIST: [<span class="number">10311</span>, <span class="string">"字典名称已存在"</span>],</span><br><span class="line">    TAG_NAME_EXIST: [<span class="number">10312</span>, <span class="string">"Tag 名称已存在"</span>],</span><br><span class="line">    OFFICE_NAME_EXIST: [<span class="number">10313</span>, <span class="string">"组织机构名称已存在"</span>],</span><br><span class="line">    ADMIN_NOT_ALLOW_DELETE: [<span class="number">10314</span>, <span class="string">"不允许删除管理员"</span>],</span><br><span class="line">    ADMIN_NOT_ALLOW_CHANGEPWD: [<span class="number">10315</span>, <span class="string">"非管理员账户不允许初始化管理员密码"</span>],</span><br><span class="line">    ADMIN_NOT_ALLOW_CHANGEINFO: [<span class="number">10316</span>, <span class="string">"非管理员账户不允许修改管理员资料"</span>],</span><br><span class="line">    NOT_ADMIN_ALLOW_DEL_ADMIN_INFO: [<span class="number">10317</span>, <span class="string">"非管理员账户不允许删除管理员角色"</span>],</span><br><span class="line">    NOT_ADMIN_ALLOW_CHANGE_ADMIN_INFO: [</span><br><span class="line">      <span class="number">10318</span>,</span><br><span class="line">      <span class="string">"非管理员账户不允许修改管理员角色"</span></span><br><span class="line">    ],</span><br><span class="line">    AREA_DATA_NULL: [<span class="number">10319</span>, <span class="string">"所选区域数据不存在"</span>],</span><br><span class="line">    USER_NOT_EXIST_OR_HASE_PWD: [<span class="number">10320</span>, <span class="string">"用户不存在或已设置密码"</span>],</span><br><span class="line">    SET_PWD_FAIL: [<span class="number">10321</span>, <span class="string">"设置密码失败"</span>],</span><br><span class="line">    CAN_NOT_DELETE_THIS_ROLE: [<span class="number">10322</span>, <span class="string">"已存在该角色的用户，不能删除"</span>],</span><br><span class="line">    CAN_NOT_DELETE_THIS_OFFICE: [<span class="number">10323</span>, <span class="string">"已存在该组织机构的用户，不能删除"</span>],</span><br><span class="line">    NOT_ALLOW_DEL_OWNER_INFO: [<span class="number">10324</span>, <span class="string">"不允许删除自己的信息"</span>],</span><br><span class="line">    <span class="string">"searchObj is not object"</span>: [<span class="number">10325</span>, <span class="string">"查询失败，缺少 searchObj 参数"</span>],</span><br><span class="line">    FILE_NOT_EXIST: [<span class="number">10401</span>, <span class="string">"附件不存在或上传失败"</span>],</span><br><span class="line">    MOBILE_EXIST: [<span class="number">10407</span>, <span class="string">"手机号已存在"</span>],</span><br><span class="line">    METHED_ERROR: [<span class="number">403</span>, <span class="string">"methed 错误。"</span>],</span><br><span class="line"></span><br><span class="line">    SEND_SMSCODE_BUSY: [<span class="number">10501</span>, <span class="string">"发送验证码操作太频繁，请稍后再试"</span>],</span><br><span class="line">    SMSCODE_EXP: [<span class="number">10502</span>, <span class="string">"验证码已过期，请重新获取验证码"</span>],</span><br><span class="line">    SMSCODE_ERR: [<span class="number">10503</span>, <span class="string">"验证码错误"</span>],</span><br><span class="line">    DAYSENDTOTLE: [<span class="number">10504</span>, <span class="string">"验证码发送量已超过单日最大量"</span>],</span><br><span class="line">    SINGLEPHONESENDTOTLE: [<span class="number">10505</span>, <span class="string">"当前号码发送验证码数量已超出系统限制"</span>],</span><br><span class="line">    SINGLEIPSENDTOTLE: [<span class="number">10506</span>, <span class="string">"当前ip地址发送验证码数量已超出系统限制"</span>],</span><br><span class="line">    <span class="comment">// 重写系统错误消息的返回</span></span><br><span class="line">    required: <span class="string">"&#123;name&#125; 不能为空"</span>,</span><br><span class="line">    contains: <span class="string">"&#123;name&#125; 必须包含 &#123;args&#125;"</span>,</span><br><span class="line">    mobile: <span class="string">"手机号码格式错误"</span>,</span><br><span class="line">    equals: <span class="string">"&#123;name&#125; 的值应该和 &#123;args&#125; 相等"</span>,</span><br><span class="line">    different: <span class="string">"&#123;name&#125; 的值应该和 &#123;args&#125; 不相等"</span>,</span><br><span class="line">    before: <span class="string">"&#123;name&#125; 应该在 &#123;args&#125; 之前"</span>,</span><br><span class="line">    after: <span class="string">"&#123;name&#125; 应该在 &#123;args&#125; 之后"</span>,</span><br><span class="line">    alpha: <span class="string">"&#123;name&#125; 的值只能是 [a-zA-Z] 组成"</span>,</span><br><span class="line">    alphaDashr: <span class="string">"&#123;name&#125; 的值只能是 [a-zA-Z] 组成"</span>,</span><br><span class="line">    alphaNumeric: <span class="string">"&#123;name&#125; 的值只能是 [a-zA-Z0-9] 组成"</span>,</span><br><span class="line">    alphaNumericDash: <span class="string">"&#123;name&#125; 的值只能是 [a-zA-Z0-9] 组成"</span>,</span><br><span class="line">    ascli: <span class="string">"&#123;name&#125; 的值只能由 ASCII 组成"</span>,</span><br><span class="line">    base64: <span class="string">"&#123;name&#125; 的值必须是 base64 编码"</span>,</span><br><span class="line">    byteLength: <span class="string">"&#123;name&#125; 的字节长度错误"</span>,</span><br><span class="line">    creditcard: <span class="string">"&#123;name&#125; 需要是信用卡数字"</span>,</span><br><span class="line">    currency: <span class="string">"&#123;name&#125; 应该是货币格式"</span>,</span><br><span class="line">    date: <span class="string">"&#123;name&#125; 应该是日期格式"</span>,</span><br><span class="line">    decimal: <span class="string">"&#123;name&#125; 应该是小数格式"</span>,</span><br><span class="line">    divisibleBy: <span class="string">"&#123;name&#125; 需要被 &#123;args&#125; 整除"</span>,</span><br><span class="line">    email: <span class="string">"&#123;name&#125; 需要是个 email 格式"</span>,</span><br><span class="line">    fqdn: <span class="string">"&#123;name&#125; 需要是个合格的域名"</span>,</span><br><span class="line">    float: <span class="string">"&#123;name&#125; 浮点数格式错误 &#123;args&#125;"</span>,</span><br><span class="line">    fullWidth: <span class="string">"&#123;name&#125; 应该包含宽字节字符"</span>,</span><br><span class="line">    halfWidth: <span class="string">"&#123;name&#125; 应该包含半字节字符"</span>,</span><br><span class="line">    hexColor: <span class="string">"&#123;name&#125; 需要是个十六进制颜色值"</span>,</span><br><span class="line">    hex: <span class="string">"&#123;name&#125; 需要是十六进制"</span>,</span><br><span class="line">    ip: <span class="string">"&#123;name&#125; 需要是 ip 格式"</span>,</span><br><span class="line">    ip4: <span class="string">"&#123;name&#125; 需要是 ip4 格式"</span>,</span><br><span class="line">    ip6: <span class="string">"&#123;name&#125; 需要是 ip6 格式"</span>,</span><br><span class="line">    isbn: <span class="string">"&#123;name&#125; 需要是图书编码"</span>,</span><br><span class="line">    isin: <span class="string">"&#123;name&#125; 需要是证券识别编码"</span>,</span><br><span class="line">    iso8601: <span class="string">"&#123;name&#125; 需要是 iso8601 日期格式"</span>,</span><br><span class="line">    <span class="keyword">in</span>: <span class="string">"&#123;name&#125; 应该在这些值中：&#123;args&#125;"</span>,</span><br><span class="line">    noin: <span class="string">"&#123;name&#125; 不应该在这些值中：&#123;args&#125;"</span>,</span><br><span class="line">    int: <span class="string">"&#123;name&#125; 整数格式错误：&#123;args&#125;"</span>,</span><br><span class="line">    min: <span class="string">"&#123;name&#125; 不能小于 &#123;args&#125;"</span>,</span><br><span class="line">    max: <span class="string">"&#123;name&#125; 不能大于 &#123;args&#125;"</span>,</span><br><span class="line">    length: <span class="string">"&#123;name&#125; 字符长度错误：&#123;args&#125;"</span>,</span><br><span class="line">    minLength: <span class="string">"&#123;name&#125; 长度不能小于 &#123;args&#125;"</span>,</span><br><span class="line">    maxLength: <span class="string">"&#123;name&#125; 长度不能大于 &#123;args&#125;"</span>,</span><br><span class="line">    lowercase: <span class="string">"&#123;name&#125; 需要都是小写字母"</span>,</span><br><span class="line">    uppercase: <span class="string">"&#123;name&#125; 需要都是大写字母"</span>,</span><br><span class="line">    mongoId: <span class="string">"&#123;name&#125; 应该是 MongoDB 的 ObjectID"</span>,</span><br><span class="line">    multibyte: <span class="string">"&#123;name&#125; 应该包含多字节字符"</span>,</span><br><span class="line">    url: <span class="string">"&#123;name&#125; 应该是个 url"</span>,</span><br><span class="line">    order: <span class="string">"&#123;name&#125; 数据库查询 order 格式错误"</span>,</span><br><span class="line">    field: <span class="string">"&#123;name&#125; 数据库查询 field 格式错误"</span>,</span><br><span class="line">    image: <span class="string">"&#123;name&#125; 上传的文件应该是个图片"</span>,</span><br><span class="line">    startWith: <span class="string">"&#123;name&#125; 应该以 &#123;args&#125; 打头"</span>,</span><br><span class="line">    endWith: <span class="string">"&#123;name&#125; 应该以 &#123;args&#125; 结尾"</span>,</span><br><span class="line">    string: <span class="string">"&#123;name&#125; 值为字符串"</span>,</span><br><span class="line">    array: <span class="string">"&#123;name&#125; 值为数组"</span>,</span><br><span class="line">    boolean: <span class="string">"&#123;name&#125; 值为布尔类型"</span>,</span><br><span class="line">    object: <span class="string">"&#123;name&#125; 值为对象"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>配置好后,可以在代码中 使用 来返回错误消息</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.fail(<span class="string">"MOBILE_EXIST"</span>); <span class="comment">//手机号已存在</span></span><br></pre></td></tr></table></figure>
<p>具体其他的校验规则可以查看 <a href="https://thinkjs.org/zh-cn/doc/3.0/logic.html" target="_blank" rel="noopener">Thinkjs 的官网</a></p>
<h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><p>控制器是处理用户请求逻辑的部分,比如将用户相关的操作都放在 <code>user.js</code> 中 ,每一个用户操作就是一个 Action,请求用户首页就是 indexAction 项目中的 controller 继承 <code>think.Controller</code>类,也可以创建一个基类,然后其他 controller 继承该类</p>
<figure class="highlight javascript"><figcaption><span>src/controller/user.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Base = <span class="built_in">require</span>(<span class="string">"./base.js"</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line">  indexAction() &#123;</span><br><span class="line">    <span class="keyword">this</span>.body = <span class="string">"hello world!"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>创建完成后,框架会监听文件变化然后重启服务.这时访问 <code>http:/.127.0.0.1:8360/user/index</code>就可以看到输出的 <code>hello world</code></p>
<h4 id="Action-的执行"><a href="#Action-的执行" class="headerlink" title="Action 的执行"></a>Action 的执行</h4><p>Action 的执行是通过 <code>think.controller</code>来完成的,执行顺序为:</p>
<ul>
<li>实例化 <code>Controller</code>类,传入 <code>ctx</code>对象</li>
<li>如果方法 <code>__before</code>存在则调用,如果返回 <code>false</code>,则停止继续执行</li>
<li>如果方法 <code>xxxAction</code>存在则执行,如果返回值为 <code>false</code> 则停止继续执行</li>
<li>如果方法 <code>xxxAction</code>不存在但 <code>__call</code>方法存在,则调用 <code>__call</code> 如果返回值为 <code>false</code>则停止继续执行</li>
<li>如果方法<code>__after</code>存在则执行</li>
</ul>
<p>下面是一个完整的 controller 示例, 列举了一般开发中所需要的功能</p>
<figure class="highlight javascript"><figcaption><span>src/controller/user.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制器是一类操作的集合, 用来响应用户同一类的请求</span></span><br><span class="line"><span class="keyword">const</span> BaseRest = <span class="built_in">require</span>(<span class="string">"./rest.js"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">BaseRest</span> </span>&#123;</span><br><span class="line">  <span class="comment">//Controller 实例化时会传入 ctx 对象，</span></span><br><span class="line">  <span class="comment">//在 Controller 里可以通过 this.ctx 来获取 ctx 对象</span></span><br><span class="line">  <span class="keyword">constructor</span>(ctx) &#123;</span><br><span class="line">    <span class="keyword">super</span>(ctx); <span class="comment">// 调用父级的 constructor 方法，并把 ctx 传递进去</span></span><br><span class="line">    <span class="comment">// 其他额外操作 可以重写 controller 方法</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 前置操作: 在 action 调用之前自动调用</span></span><br><span class="line">  <span class="comment">// 推荐放在一个 base controller 类中, 其他 controller 继承 base controller</span></span><br><span class="line">  <span class="keyword">async</span> __before() &#123;</span><br><span class="line">    <span class="comment">// 判断是否已经登录，如果没有登录就不能继续后面行为。</span></span><br><span class="line">    <span class="comment">//此种情况下，可以通过内置的 __before 来实现</span></span><br><span class="line">    <span class="keyword">const</span> userInfo = <span class="keyword">await</span> <span class="keyword">this</span>.session(<span class="string">"userInfo"</span>);</span><br><span class="line">    <span class="comment">//获取用户的 session 信息，如果为空，返回 false 阻止后续的行为继续执行</span></span><br><span class="line">    <span class="keyword">if</span> (think.isEmpty(userInfo)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 后置操作: 在 action 调用之后自动调用</span></span><br><span class="line">  __after() &#123;</span><br><span class="line">    <span class="comment">// 如果 action 里阻止了后续的代码继续执行(return false), 则后置操作不会调用</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"controller __after"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 空操作: 当解析后的 URL 对应的控制器存在, 但 action 不存在时调用</span></span><br><span class="line">  <span class="comment">// 一般不需要使用</span></span><br><span class="line">  __call() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"controller __call"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.end(<span class="string">"404"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 不指定 action 时默认用 indexAction 来处理这个请求</span></span><br><span class="line">  indexAction() &#123;</span><br><span class="line">    <span class="comment">// 获取 URL</span></span><br><span class="line">    <span class="comment">// 获取请求参数</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"GET param"</span>, <span class="keyword">this</span>.get()); <span class="comment">// 相当于  this.ctx.param</span></span><br><span class="line">    <span class="comment">// 当上传文件时, 包含 form 表单中除开 file 类型的其他字段的值</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"POST param"</span>, <span class="keyword">this</span>.post());</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"GET param"</span>, <span class="keyword">this</span>.param());</span><br><span class="line">    <span class="comment">// 上传的文件保存在临时目录(runtime/upload)中, 可以通过 path 属性看到</span></span><br><span class="line">    <span class="comment">// 使用时需要将其移动到项目里的目录, 否则请求结束时会被删除</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"file"</span>, <span class="keyword">this</span>.file());</span><br><span class="line">    <span class="comment">// 获取模型数据</span></span><br><span class="line">    <span class="comment">// 一般放到 Model 文件夹下操作</span></span><br><span class="line">    <span class="comment">// 项目开发中, 经常要操作数据库, 如: 增删改查等操作.</span></span><br><span class="line">    <span class="comment">// 模型就是为了方便操作数据库进行的封装, 一个模型对应数据库中的一个数据表.</span></span><br><span class="line">    <span class="comment">// 模型文件不是必须存在, 如果没有自定义方法可以不创建模型文件,</span></span><br><span class="line">    <span class="comment">// 实例化时会取模型基类的实例</span></span><br><span class="line">    <span class="keyword">let</span> model = <span class="keyword">this</span>.model(<span class="string">"city"</span>);</span><br><span class="line">    <span class="comment">// 操作模型</span></span><br><span class="line">    model</span><br><span class="line">      .where(&#123; <span class="attr">name</span>: <span class="string">"Kabul"</span> &#125;)</span><br><span class="line">      .select()</span><br><span class="line">      .then(<span class="function"><span class="keyword">function</span>(<span class="params">rs</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"model"</span>, model.name, model.schema, rs);</span><br><span class="line">      &#125;);</span><br><span class="line">    <span class="comment">// 指定 SQL 语句执行查询</span></span><br><span class="line">    <span class="keyword">this</span>.model()</span><br><span class="line">      .query(<span class="string">"SELECT * FROM city WHERE name = '%s'"</span>, <span class="string">"Kabul"</span>)</span><br><span class="line">      .then(<span class="function"><span class="keyword">function</span>(<span class="params">rs</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(rs);</span><br><span class="line">      &#125;);</span><br><span class="line">    <span class="comment">// View 模板赋值</span></span><br><span class="line">    <span class="keyword">this</span>.assign(&#123;</span><br><span class="line">      title: <span class="string">"我们一起来学习 ThinkJS"</span>,</span><br><span class="line">      author: <span class="string">"Sun"</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 渲染模板</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.display();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回 JSON/JSONP</span></span><br><span class="line">    <span class="comment">// return this.json(&#123;a: 1&#125;);</span></span><br><span class="line">    <span class="comment">// return this.jsonp(&#123;a: 1&#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回格式化的正常数据, 一般是操作成功后输出</span></span><br><span class="line">    <span class="comment">// return this.success(&#123;a: 1&#125;);</span></span><br><span class="line">    <span class="comment">// 返回格式化的异常数据, 一般是操作失败后输出</span></span><br><span class="line">    <span class="comment">// return this.fail(1000, 'error...', &#123;e: 1&#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跳转页面</span></span><br><span class="line">    <span class="comment">// return this.redirect('https://thinkjs.org');</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 多模块的</span></span><br><span class="line">  <span class="comment">// http://127.0.0.1:8360/模块/控制器/操作</span></span><br><span class="line">  <span class="comment">// 单模块的</span></span><br><span class="line">  <span class="comment">// http://127.0.0.1:8360/user/insert?callback=abc</span></span><br><span class="line">  <span class="comment">// http://127.0.0.1:8360/控制器/操作</span></span><br><span class="line">  <span class="keyword">async</span> insertAction() &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> now = think.datetime(<span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">      <span class="keyword">let</span> data = <span class="keyword">this</span>.post(); <span class="comment">//post数据json格式化</span></span><br><span class="line">      <span class="comment">// 项目中处理 data 数据的函数,不用理会</span></span><br><span class="line">      <span class="keyword">let</span> result = <span class="keyword">this</span>.convertToEntity(data);</span><br><span class="line">      result.id = think.uuid(); <span class="comment">// undefined的数据添加</span></span><br><span class="line">      result.create_date = now;</span><br><span class="line">      <span class="comment">// serviceinstance 是 service 文件夹下同名的文件</span></span><br><span class="line">      <span class="comment">// 调用对应的 model 操作数据库</span></span><br><span class="line">      <span class="comment">// 把结果返回给 controller</span></span><br><span class="line">      <span class="comment">//调用service对应的insert方法</span></span><br><span class="line">      <span class="keyword">let</span> id = <span class="keyword">await</span> <span class="keyword">this</span>.serviceInstance.insert(result).catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">// 生成日志记录插入数据库</span></span><br><span class="line">      <span class="keyword">this</span>.dbLogInfo(<span class="string">"sys_test管理"</span>, <span class="string">`【成功】新增单条sys_test:<span class="subst">$&#123;result.id&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.success(result.id);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.fail(error.message);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="View"><a href="#View" class="headerlink" title="View"></a>View</h3><p>thinkjs 框架并没有内置 view/视图功能,如果需要在 <code>src/config/extend.js</code>,添加如下的配置:</p>
<figure class="highlight javascript"><figcaption><span>src/config/extend.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> view = <span class="built_in">require</span>(<span class="string">"think-view"</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = [view];</span><br></pre></td></tr></table></figure>
<p>添加视图扩展,让项目有渲染模板文件的能力,视图扩展是通过模块 <code>think-view</code>实现的. 配置好 extend 后还需要配置 adapter ,在 <code>src/config/adapter.js</code>中添加如下的配置:</p>
<figure class="highlight javascript"><figcaption><span>src/config/adapter.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> nunjucks = <span class="built_in">require</span>(<span class="string">"think-view-nunjucks"</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 视图的 adapter 名称为 view</span></span><br><span class="line">exports.view = &#123;</span><br><span class="line">  type: <span class="string">"nunjucks"</span>, <span class="comment">// 这里指定默认的模板引擎是 nunjucks</span></span><br><span class="line">  common: &#123;</span><br><span class="line">    viewPath: path.join(think.ROOT * PATH, <span class="string">"view"</span>), <span class="comment">//模板文件的根目录</span></span><br><span class="line">    sep: <span class="string">"*"</span>, <span class="comment">//Controller 与 Action 之间的连接符</span></span><br><span class="line">    extname: <span class="string">".html"</span> <span class="comment">//模板文件扩展名</span></span><br><span class="line">  &#125;,</span><br><span class="line">  nunjucks: &#123;</span><br><span class="line">    handle: nunjucks,</span><br><span class="line">    beforeRender: <span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;, <span class="comment">// 模板渲染预处理</span></span><br><span class="line">    options: &#123;</span><br><span class="line">      <span class="comment">// 模板引擎额外的配置参数</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里用的模板引擎是 nunjucks，项目中可以根据需要修改。</p>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><p>配置好 Extend 和 Adapter 后就可以在 Controller 中使用了.如:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">moduel.exports = <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">think</span>.<span class="title">Controller</span> </span>&#123;</span><br><span class="line">  indexAction() &#123;</span><br><span class="line">    <span class="keyword">this</span>.assign(<span class="string">"title"</span>, <span class="string">"thinkjs"</span>); <span class="comment">//给模板赋值</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.display(); <span class="comment">// 渲染模板</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="其他方法"><a href="#其他方法" class="headerlink" title="其他方法"></a>其他方法</h4><p><strong>assign: </strong>给模板赋值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//单条赋值</span></span><br><span class="line"><span class="keyword">this</span>.assign(<span class="string">"title"</span>, <span class="string">"thinkjs"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//多条赋值</span></span><br><span class="line"><span class="keyword">this</span>.assign(&#123;</span><br><span class="line">  title: <span class="string">"thinkjs"</span>,</span><br><span class="line">  name: <span class="string">"test"</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取之前赋过的值，如果不存在则为 undefined</span></span><br><span class="line"><span class="keyword">const</span> title = <span class="keyword">this</span>.assign(<span class="string">"title"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取所有赋的值</span></span><br><span class="line"><span class="keyword">const</span> assignData = <span class="keyword">this</span>.assign();</span><br></pre></td></tr></table></figure>
<p><strong>display &amp;&amp; render: </strong>渲染模板/切换模板类型<br><code>render:</code> 获取渲染后的内容,该方法为异步方法,需要通过 async/await 处理<br><code>display:</code> 调用的是 <code>render</code>方法获取 模板内容后 再把内容加到 <code>ctx.body</code>内容上<br>项目中如果使用 display 话,前面要记得加上 <code>await</code>或者是 <code>return</code></p>
<figure class="highlight javascript"><figcaption><span>render.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//render</span></span><br><span class="line"><span class="comment">//根据当前请求解析的 controller 和 action 自动匹配模板文件</span></span><br><span class="line"><span class="keyword">const</span> content1 = <span class="keyword">await</span> <span class="keyword">this</span>.render();</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定文件名</span></span><br><span class="line"><span class="keyword">const</span> content2 = <span class="keyword">await</span> <span class="keyword">this</span>.render(<span class="string">"doc"</span>);</span><br><span class="line"><span class="keyword">const</span> content3 = <span class="keyword">await</span> <span class="keyword">this</span>.render(<span class="string">"doc/detail"</span>);</span><br><span class="line"><span class="keyword">const</span> content4 = <span class="keyword">await</span> <span class="keyword">this</span>.render(<span class="string">"doc_detail"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//不指定文件名但切换模板类型</span></span><br><span class="line"><span class="keyword">const</span> content5 = <span class="keyword">await</span> <span class="keyword">this</span>.render(<span class="literal">undefined</span>, <span class="string">"ejs"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定文件名且切换模板类型</span></span><br><span class="line"><span class="keyword">const</span> content6 = <span class="keyword">await</span> <span class="keyword">this</span>.render(<span class="string">"doc"</span>, <span class="string">"ejs"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//切换模板类型，并配置额外的参数</span></span><br><span class="line"><span class="comment">//切换模板类型时，需要在 adapter 配置里配置对应的类型</span></span><br><span class="line"><span class="keyword">const</span> content7 = <span class="keyword">await</span> <span class="keyword">this</span>.render(<span class="string">"doc"</span>, &#123;</span><br><span class="line">  type: <span class="string">"ejs"</span>,</span><br><span class="line">  xxx: <span class="string">"yyy"</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><figcaption><span>display.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据当前请求解析的 controller 和 action 自动匹配模板文件</span></span><br><span class="line"><span class="keyword">await</span> <span class="keyword">this</span>.display();</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定文件名</span></span><br><span class="line"><span class="keyword">await</span> <span class="keyword">this</span>.display(<span class="string">"doc"</span>);</span><br><span class="line"><span class="keyword">await</span> <span class="keyword">this</span>.display(<span class="string">"doc/detail"</span>);</span><br><span class="line"><span class="keyword">await</span> <span class="keyword">this</span>.display(<span class="string">"doc_detail"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//不指定文件名切换模板类型</span></span><br><span class="line"><span class="keyword">await</span> <span class="keyword">this</span>.display(<span class="literal">undefined</span>, <span class="string">"ejs"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定文件名且切换模板类型</span></span><br><span class="line"><span class="keyword">await</span> <span class="keyword">this</span>.display(<span class="string">"doc"</span>, <span class="string">"ejs"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//切换模板类型，并配置额外的参数</span></span><br><span class="line"><span class="keyword">await</span> <span class="keyword">this</span>.display(<span class="string">"doc"</span>, &#123;</span><br><span class="line">  type: <span class="string">"ejs"</span>,</span><br><span class="line">  xxx: <span class="string">"yyy"</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="默认注入的参数"><a href="#默认注入的参数" class="headerlink" title="默认注入的参数"></a>默认注入的参数</h4><p>框架在渲染模板的时候,自动注入了 <code>controller</code>/<code>config</code>/<code>ctx</code>变量,可以直接在模板里调用方法,获取配置<br><code>controller</code><br>当前控制器实例,在模板里可以直接调用控制器上的属性和方法.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; if controller.type === 'xxx'&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>当前 type 为 xxx<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&#123;&#123; endif &#125;&#125;</span><br></pre></td></tr></table></figure>
<p><code>config</code><br>所有的配置，在模板里可以直接通过 <code>config.xxx</code>来获取配置，如果属性不存在，那么值为 <code>undefined</code>。<br><code>ctx</code><br>当前请求的 Context 对象，在模板里可以直接通过 <code>ctx.xxx</code>调用其属性或者 <code>ctx.yyy()</code>调用其方法。<br>如果是调用其方法，那么方法必须为一个 <code>同步方法</code>。</p>
<h3 id="Route"><a href="#Route" class="headerlink" title="Route"></a>Route</h3><p>在 ThinkJS 中，当用户访问一个 URL 时，最后是通过 <code>controller</code>里具体的 <code>action</code>来响应的。所以就需要解析出 URL 对应的<code>controller</code> 和<code>action</code>，这个解析工作是通过 <code>think-router</code>模块实现的。</p>
<h4 id="think-router-配置"><a href="#think-router-配置" class="headerlink" title="think-router 配置"></a>think-router 配置</h4><p>think-router 是一个 middleware，项目创建时默认已经加到配置文件 <code>src/config/middleware.js</code>里了，其中 options 支持如下的参数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">  &#123;</span><br><span class="line">    handle: <span class="string">"router"</span>,</span><br><span class="line">    options: &#123;</span><br><span class="line">      <span class="comment">//多模块项目下，默认的模块名。默认值为 home</span></span><br><span class="line">      defaultModule: <span class="string">"home"</span>,</span><br><span class="line">      <span class="comment">//默认的控制器名，默认值为 index</span></span><br><span class="line">      defaultController: <span class="string">"index"</span>,</span><br><span class="line">      <span class="comment">//默认的操作名，默认值为 index</span></span><br><span class="line">      defaultAction: <span class="string">"index"</span>,</span><br><span class="line">      <span class="comment">//默认去除的 pathname 前缀，默认值为 []</span></span><br><span class="line">      prefix: [],</span><br><span class="line">      <span class="comment">//默认去除的 pathname 后缀，默认值为</span></span><br><span class="line">      suffix: [<span class="string">".html"</span>],</span><br><span class="line">      <span class="comment">//在不匹配情况下是否使用默认路由解析，默认值为 true</span></span><br><span class="line">      enableDefaultRouter: <span class="literal">true</span>,</span><br><span class="line">      <span class="comment">//子域名映射下的偏移量，默认值为 2</span></span><br><span class="line">      subdomainOffset: <span class="number">2</span>,</span><br><span class="line">      <span class="comment">//子域名映射列表，默认为 &#123;&#125;</span></span><br><span class="line">      subdomain: &#123;&#125;,</span><br><span class="line">      <span class="comment">//多模块项目下，禁止访问的模块列表，默认为 []</span></span><br><span class="line">      denyModules: []</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<h4 id="路由对路径的处理"><a href="#路由对路径的处理" class="headerlink" title="路由对路径的处理"></a>路由对路径的处理</h4><p>当用户访问一个 URL 时,最终执行那个模块下那个控制器的那个操作,这是由路由解析后来决定的.具体的流程为:</p>
<ol>
<li>首先路由会将 URL 解析为 pathname<br>例如: <code>http://127.0.0.1:8360/test/index.html</code>, 将 URL 进行解析(去除 host 信息)得到的 pathname 为 <code>/test/index.html</code></li>
<li>然后会对 pathname 过滤<br>因为有时候为了搜索引擎优化或者一些其他的原因, URL 上会多加一些东西. 比如: 当前页面是一个动态页面, 但 URL 最后加了 <code>.html</code>, 这样对搜索引擎更加友好. 但这些在后续的路由解析中是无用的, 需要去除.<br>默认会去除配置的 pathname 前缀和后缀内容, 以及自动去除左右的 <code>/</code></li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pathname_prefix: <span class="string">""</span>,</span><br><span class="line">pathname_suffix: <span class="string">".html"</span></span><br></pre></td></tr></table></figure>
<p>因此经过路由处理后, 会拿到干净的 pathname, 我们就可以根据这个 pathname 来判断执行哪个模块下哪个控制器的哪个操作了.</p>
<p>例如:</p>
<ul>
<li><code>http://127.0.0.1:8360/test/index.html</code> URL</li>
<li><code>/test/index.html</code> 解析</li>
<li><code>test/index</code> 过滤</li>
<li>路由识别默认根据 <code>模块/控制器/操作/参数1/参数1值/参数2/参数2值</code> 来识别过滤后的 pathname</li>
<li>当解析 pathname 没有对应的值时, 便使用对应的默认值<ul>
<li>其中<code>模块</code>默认值为 <code>home</code>, <code>controller</code> 默认值为 <code>index</code>, <code>action</code> 默认值为 <code>index</code></li>
<li>大小写转换</li>
<li>路由识别后, module、controller 和 action 值都会自动转为小写, 如果 action 值里有 <code>_</code>, 会作一些转化, 如: 假设识别后的 controller 值为 <code>index</code>, action 值为 <code>user_add</code>, 那么对应的 action 方法名为 <code>userAddAction</code>, 但模版名还是 <code>index_user_add.html</code></li>
</ul>
</li>
<li>这里要分项目是单模块还是多模块的<ul>
<li>如果是单模块项目的话,上面的 URL 会调用 <code>home</code> 模块(module)的 <code>test</code> 控制器(controller)的 <code>index</code> 操作(action)<ul>
<li>即: <code>src/controller/index.js#indexAction</code></li>
</ul>
</li>
<li>如果是多模块项目的话,上面的 URL 会调用 <code>test</code> 模块(module)的 <code>index</code> 控制器(controller)的 <code>index</code> 操作(action)<ul>
<li>即: <code>src/test/controller/index.js#indexAction</code></li>
</ul>
</li>
</ul>
</li>
<li>默认的视图文件路径为 <code>view/[module]/[controller]_[action].html</code> 即 <code>模块/控制器_操作.html</code></li>
<li>因此 <code>display()</code> 时对应的视图为: <code>view/home/index_index.html</code>或者是<code>view/test/index_index.html</code></li>
</ul>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>项目中，有时候除了查询数据库等操作外，也需要调用远程的一些接口，如：调用 GitHub 的接口、调用发送短信的接口等等。</p>
<p>这种功能放在 Model 下是不太合适的，为此，框架提供了 Service 来解决此类问题。</p>
<p>Service 文件存放在 <code>src/service/</code>（多模块在 <code>src/common/service/</code>）目录下，文件内容格式如下：</p>
<figure class="highlight javascript"><figcaption><span>src/service/test.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">think</span>.<span class="title">Service</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;&#125;</span><br><span class="line">  xxx() &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Service 都继承 think.Service 基类，但该基类不提供任何方法，可以通过 Extend 进行扩展。</p>
<p>可以在项目根目录下通过<code>thinkjs service xxx</code>命令创建 service 文件，支持多级目录。<br>项目启动时,会扫描项目下所有的 services 文件,并存放到 <code>think.app.services</code>对象下,实例化 Services 类时,会从该对象上查找对应的文件,可以通过<code>think.service</code> <code>ctx.service</code> <code>controller.service</code> 获取到 Services 的实例,然后使用该实例上定义的方法,具体的获得方法类似于下面 Model 实例的获取.</p>
<h4 id="无参数类的实例化"><a href="#无参数类的实例化" class="headerlink" title="无参数类的实例化"></a>无参数类的实例化</h4><figure class="highlight javascript"><figcaption><span>src/service/sms.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">think</span>.<span class="title">Service</span> </span>&#123;</span><br><span class="line">  xxx() &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实例化，没有任何参数</span></span><br><span class="line"><span class="keyword">const</span> sms = think.service(<span class="string">"sms"</span>);</span><br><span class="line">sms.xxx();</span><br><span class="line"><span class="comment">// 多模块项目的实例化</span></span><br><span class="line"><span class="comment">// const sms = think.service('sms', 'home');</span></span><br></pre></td></tr></table></figure>
<h4 id="有参数类的实例化"><a href="#有参数类的实例化" class="headerlink" title="有参数类的实例化"></a>有参数类的实例化</h4><figure class="highlight javascript"><figcaption><span>src/service/sms.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">think</span>.<span class="title">Service</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(key, secret) &#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">this</span>.key = key;</span><br><span class="line">    <span class="keyword">this</span>.secret = secret;</span><br><span class="line">  &#125;</span><br><span class="line">  xxx() &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带参数的实例化</span></span><br><span class="line"><span class="keyword">const</span> sms = think.service(<span class="string">"sms"</span>, key, secret);</span><br><span class="line">sms.xxx();</span><br><span class="line"><span class="comment">// 多模块项目的实例化</span></span><br><span class="line"><span class="comment">// 指定从 home 下查找 sms 的 service 类</span></span><br><span class="line"><span class="comment">// const sms = think.service('sms', 'home', key, secret)</span></span><br></pre></td></tr></table></figure>
<h4 id="扩展-Services-类"><a href="#扩展-Services-类" class="headerlink" title="扩展 Services 类"></a>扩展 Services 类</h4><p><code>think.service</code>基类没有提供任何方法,如果需要可以在<code>src/extend/service.js</code>中定义,然后就可以在项目中直接使用这个方法</p>
<figure class="highlight javascript"><figcaption><span>src/extend/service.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  getDataFromApi() &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><figcaption><span>src/service/sms.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">think</span>.<span class="title">Service</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> xxx() &#123;</span><br><span class="line">    <span class="comment">// 这个访问 extend/service.js 扩展的方法</span></span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="keyword">this</span>.getDatafromApi();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>service 类中,调用 model 数据库操作,或者调用其他接口,然后把得到的数据再返回给 Controller,起到一个承上启下的作用</p>
<h3 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h3><p>thinkjs 默认没有提供模型的功能,需要添加相应的扩展来支持,对应的扩展为 <code>think-model</code>.修改的配置文件<code>src/config/extend.js</code> 和 <code>src/config/adapter.js</code></p>
<figure class="highlight javascript"><figcaption><span>src/config/extend.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> model = <span class="built_in">require</span>(<span class="string">"think-model"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">  model(think.app) <span class="comment">// 让框架支持模型的功能</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>添加模型的扩展后,会添加 <code>think.Model</code>/<code>think.model</code>/<code>ctx.model</code>/<code>controller.model</code>/<code>service.model</code>可以在文件中通过对应的方法获得 model 的实例.</p>
<figure class="highlight javascript"><figcaption><span>src/config/adapter.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">'think-model-mysql'</span>);</span><br><span class="line"></span><br><span class="line">exports.model = &#123;</span><br><span class="line">    type: <span class="string">'mysql'</span>, <span class="comment">// 默认使用的类型，调用时可以指定参数切换</span></span><br><span class="line">    common: &#123; <span class="comment">// 通用配置</span></span><br><span class="line">        logConnect: <span class="literal">true</span>, <span class="comment">// 是否打印数据库连接信息</span></span><br><span class="line">        logSql: <span class="literal">true</span>, <span class="comment">// 是否打印 SQL 语句</span></span><br><span class="line">        logger: <span class="function"><span class="params">msg</span> =&gt;</span> think.logger.info(msg) <span class="comment">// 打印信息的 logger</span></span><br><span class="line">    &#125;,</span><br><span class="line">    mysql: &#123; <span class="comment">// mysql 配置</span></span><br><span class="line">        handle: mysql</span><br><span class="line">        user: <span class="string">'root'</span>, <span class="comment">// 用户名</span></span><br><span class="line">        password: <span class="string">''</span>, <span class="comment">// 密码</span></span><br><span class="line">        database: <span class="string">''</span>, <span class="comment">// 数据库</span></span><br><span class="line">        host: <span class="string">'127.0.0.1'</span>, <span class="comment">// host</span></span><br><span class="line">        port: <span class="number">3306</span>, <span class="comment">// 端口</span></span><br><span class="line">        connectionLimit: <span class="number">1</span>, <span class="comment">// 连接池的连接个数，默认为 1</span></span><br><span class="line">        <span class="comment">// 数据表前缀，</span></span><br><span class="line">        <span class="comment">//如果一个数据库里有多个项目，那项目之间的数据表可以通过前缀来区分</span></span><br><span class="line">        prefix: <span class="string">''</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    mysql2: &#123; <span class="comment">// 另一个 mysql 的配置</span></span><br><span class="line">        handle: mysql</span><br><span class="line">    &#125;,</span><br><span class="line">    sqlite: &#123; <span class="comment">// sqlite 配置</span></span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">    postgresql: &#123; <span class="comment">// postgresql 配置</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>项目中如果需要切换 Model 的类型,可以在调用 model 时通过不同的 type 区分</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用默认的数据库配置，默认的 type 为 mysql，那么就是使用 mysql 的配置</span></span><br><span class="line"><span class="keyword">const</span> user1 = think.model(<span class="string">"user"</span>);</span><br><span class="line"><span class="comment">// 使用 mysql2 的配置</span></span><br><span class="line"><span class="keyword">const</span> user2 = think.model(<span class="string">"user"</span>, <span class="string">"mysql2"</span>);</span><br><span class="line"><span class="comment">// 使用 sqlite 的配置</span></span><br><span class="line"><span class="keyword">const</span> user3 = think.model(<span class="string">"user"</span>, <span class="string">"sqlite"</span>);</span><br><span class="line"><span class="comment">// 使用 postgresql 的配置</span></span><br><span class="line"><span class="keyword">const</span> user4 = think.model(<span class="string">"user"</span>, <span class="string">"postgresql"</span>);</span><br></pre></td></tr></table></figure>
<p>thinkjs 框架有个方便的地方就是 你可以在项目的任何地方获得 Model 的实例,然后使用该实例上定义的方法,这一点和 Service 一样</p>
<h4 id="实例化模型"><a href="#实例化模型" class="headerlink" title="实例化模型"></a>实例化模型</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">think.model(<span class="string">"user"</span>); <span class="comment">// 获取模型的实例</span></span><br><span class="line">think.model(<span class="string">"user"</span>, <span class="string">"sqlite"</span>); <span class="comment">// 获取模型的实例，修改数据库的类型</span></span><br><span class="line">think.model(<span class="string">"user"</span>, &#123;</span><br><span class="line">  <span class="comment">// 获取模型的实例，修改类型并添加其他的参数</span></span><br><span class="line">  type: <span class="string">"sqlite"</span>,</span><br><span class="line">  aaa: <span class="string">"bbb"</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 获取模型的实例，指定为 admin 模块（多模块项目下有效）</span></span><br><span class="line">think.model(<span class="string">"user"</span>, &#123;&#125;, <span class="string">"admin"</span>);</span><br></pre></td></tr></table></figure>
<h4 id="ctx-model"><a href="#ctx-model" class="headerlink" title="ctx.model"></a>ctx.model</h4><p>实例化模型类，获取配置后调用 think.model 方法，多模块项目下会获取当前模块下的配置.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cosnt user = ctx.model(<span class="string">'user'</span>);</span><br></pre></td></tr></table></figure>
<h4 id="controller-model"><a href="#controller-model" class="headerlink" title="controller.model"></a>controller.model</h4><p>实例化模型类，获取配置后调用 think.model 方法，多模块项目下会获取当前模块下的配置.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">think</span>.<span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> indexAction() &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">this</span>.model(<span class="string">"user"</span>); <span class="comment">// controller 里实例化模型</span></span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> user.select();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.success(data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="Service-model"><a href="#Service-model" class="headerlink" title="Service.model"></a>Service.model</h4><p>实例化模型类,等同于<code>think.model</code></p>
<p>thinkjs 对数据库的增删改查的操作封装具体请查看 think.js 的官网</p>
<h3 id="Cookie-amp-amp-Session"><a href="#Cookie-amp-amp-Session" class="headerlink" title="Cookie &amp;&amp; Session"></a>Cookie &amp;&amp; Session</h3><h4 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h4><p>thinkjs 中对 cookie 的配置代码在<code>src/config/config.js</code>中修改,支持如下的配置:</p>
<ul>
<li><code>maxAge:</code> cookie 的超时时间，表示当前时间（Date.now()）之后的毫秒数。</li>
<li><code>expires:</code> Date 对象，表示 cookie 的到期时间（不指定的话，默认是在会话结束时过期）。</li>
<li><code>path:</code> 字符串，表示 cookie 的路径（默认是/）。</li>
<li><code>domain:</code> 字符串，表示 cookie 的域（没有默认值）。</li>
<li><code>secure:</code> 布尔值，表示是否只通过 HTTPS 发送该 cookie（false 时默认通过 HTTP 发送，true 时默认通过 HTTPS 发送）。</li>
<li><code>httpOnly:</code> 布尔值，表示是否只通过 HTTP(S)发送该 cookie，而不能被客户端的 JavaScript 访问到（默认是 true）。</li>
<li><code>sameSite:</code> 布尔值或字符串，表示是否该 cookie 是一个“同源” cookie（默认是 false）。可以将其设置为<code>&#39;strict&#39;</code>，<code>&#39;lax&#39;</code>，或<code>true</code> （等价于 strict）。</li>
<li><code>overwrite:</code> 布尔值，表示是否覆盖以前设置的同名 cookie（默认为 false）。如果设为 true，在同一个请求中设置的相同名称（不管路径或域）的所有 cookie 将在设置此 cookie 时从 Set-Cookie 头中过滤掉</li>
<li><code>signed:</code> 布尔值，表示是否要将该 cookie 签名（默认是 false）。如果设为 true，还会发送另一个带有.sig 后缀的同名 cookie，值为一个 27 字节的 url-safe base64 SHA1 值，表示<em>cookie-name </em> = <em> cookie-value</em>的散列值，相对于第一个 Keygrip 键。 此签名密钥用于在下次接收到 cookie 时检测篡改。</li>
</ul>
<p>一般配置:</p>
<figure class="highlight javascript"><figcaption><span>src/config/config.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    cookie: &#123;</span><br><span class="line">        domain: <span class="string">''</span>,<span class="comment">//cookie 的域</span></span><br><span class="line">        path: <span class="string">'/'</span>,<span class="comment">//cookie 的路径</span></span><br><span class="line">        maxAge: <span class="number">10</span> _ <span class="number">3600</span> _ <span class="number">1000</span>, <span class="comment">// 10 个小时过期时间</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>thinkjs 支持 cookie 的操作,具体代码如下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取 cookie</span></span><br><span class="line"><span class="keyword">const</span> theme = <span class="keyword">this</span>.cookie(<span class="string">"theme"</span>);</span><br><span class="line"><span class="comment">// 设置 cookie</span></span><br><span class="line"><span class="keyword">this</span>.cookie(<span class="string">"theme"</span>, <span class="string">"gray"</span>);</span><br><span class="line"><span class="comment">// 设定 cookie 时指定额外的配置</span></span><br><span class="line"><span class="keyword">this</span>.cookie(<span class="string">"theme"</span>, <span class="string">"yellow"</span>, &#123;</span><br><span class="line">  maxAge: <span class="number">10</span> * <span class="number">1000</span>,</span><br><span class="line">  path: <span class="string">"/theme"</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//删除 cookie</span></span><br><span class="line"><span class="keyword">this</span>.cookie(<span class="string">"theme"</span>, <span class="literal">null</span>);</span><br><span class="line"><span class="comment">//如果设置的时候有 domain 和 path 的操作</span></span><br><span class="line"><span class="comment">//删除的时候同样也要清空,否则会因为不匹配导致操作失败</span></span><br><span class="line"><span class="keyword">this</span>.cookie(<span class="string">"theme"</span>, <span class="literal">null</span>, &#123;</span><br><span class="line">  domain: <span class="string">""</span>,</span><br><span class="line">  path: <span class="string">""</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h4><p>框架通过<code>think-session</code>来扩展支持,需要配置的文件:</p>
<figure class="highlight javascript"><figcaption><span>src/config/extend.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">"think-session"</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = [session];</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><figcaption><span>src/config/adapter.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fileSession = <span class="built_in">require</span>(<span class="string">"think-session-file"</span>);</span><br><span class="line"></span><br><span class="line">exports.session = &#123;</span><br><span class="line">  type: <span class="string">"file"</span>,</span><br><span class="line">  common: &#123;</span><br><span class="line">    cookie: &#123;</span><br><span class="line">      name: <span class="string">"thinkjs"</span></span><br><span class="line">      <span class="comment">// keys: ['werwer', 'werwer'],</span></span><br><span class="line">      <span class="comment">// signed: true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  file: &#123;</span><br><span class="line">    handle: fileSession,</span><br><span class="line">    sessionPath: path.join(think.ROOT_PATH, <span class="string">"runtime/session"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>cookie 选项为 session 设置 cookie 时的配置项，会和 think.config(‘cookie’) 值进行合并，name 字段值为 session 对应 cookie 的名字。</p>
<h4 id="session-操作"><a href="#session-操作" class="headerlink" title="session 操作"></a>session 操作</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">think</span>.<span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> indexAction() &#123;</span><br><span class="line">    <span class="comment">//读取 session</span></span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="keyword">this</span>.session(<span class="string">"name"</span>);</span><br><span class="line">    <span class="comment">//设置 session</span></span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="keyword">this</span>.session(<span class="string">"name"</span>, <span class="string">"value"</span>);</span><br><span class="line">    <span class="comment">//删除整个 session</span></span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="keyword">this</span>.session(<span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>参考链接</p>
</blockquote>
<ul>
<li><a href="https://github.com/f2e-journey/xueqianban/issues/47" target="_blank" rel="noopener">我的 thinkjs 之旅</a></li>
<li><a href="https://thinkjs.org/zh-cn/doc/3.0/index.html" target="_blank" rel="noopener">thinkjs 官网</a></li>
</ul>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="http://www.tiankai.party">tiankai</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="http://www.tiankai.party/posts/42422/">http://www.tiankai.party/posts/42422/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span>
      
      <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>

      
      
  <div class="post-reward">
    <input type="checkbox" name="reward" id="reward" hidden>
    <label class="reward-button" for="reward">赞赏支持</label>
    <div class="qr-code">
      
      
        <label class="qr-code-image" for="reward">
          <img class="image" src="/imgs/wechat.jpg" title="wechat">
        </label>
      
      
        <label class="qr-code-image" for="reward">
          <img class="image" src="/imgs/ali.jpg" title="alipay">
        </label>
      
    </div>
  </div>

    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/nodejs/">nodejs</a>
            
              <a href="/tags/thinkjs/">thinkjs</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/posts/40486/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">nginx初见</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/posts/51002/">
        <span class="next-text nav-default">Emacs的配置和使用</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
    <div id="gitalk-container"></div>
    
  </div>
  

        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:tiankai0426@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/tiakia" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>



<div class="copyright">
  <span class="copyright-year">
    
    &copy; 
     
      2017 - 
    
    2019

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">tiankai</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  

  
  
  <script>
     (function() {
         function render() {
             new Gitalk({
                 clientID: "d45abc7a6db571b50af9",
                 clientSecret: "15ab54f8f528045cdf07d8dbb2d4c0faa69f9462",
                 owner: 'tiakia',
                 repo: 'tiakiaBlogComment',
                 admin: ['tiakia'],
                 id: decodeURI(location.pathname)
             }).render('gitalk-container')
         }
         var gc = document.createElement('script');
         gc.type = 'text/javascript';
         gc.src = '//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js';
         gc.charset = 'UTF-8';
         gc.onload = render;
         gc.async = true;
         document.querySelector('body').appendChild(gc);
         var gcs = document.createElement('link');
         gcs.href = '//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css';
         gcs.type = 'text/css';
         gcs.rel = 'stylesheet';
         gcs.media = 'screen,print';
         document.querySelector('head').appendChild(gcs);
     })();
    </script>

  



    
  



  
  





  
    <script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

  
    <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.10.1"></script>

  </body>
</html>
